<html lang="nb" >
    <head>
        <title>Spout</title>
        <meta charset="UTF-8">
        <style>
            h1 {
                color: red;
            }
            fieldset {
                background-color: aqua;
            }
        </style>
    </head>
    <body>
        <h1>Spout away {{innloggetbruker}}</h1>
        <label for="events">Events:</label>

        <select name="events" id="events">
            <option value="blank">Blanke ark</option>
            <option value="paminnelse">Påminn vedtaksperiode</option>
            <option value="annullering">Annuller utbetaling</option>
            <option value="forkast_sykmeldingsperioder">Forkast sykmeldingsperioder</option>
        </select>
        <br/><br/>
        <form method="post" action="/melding", id="sendmelding">
            <textarea hidden name="json" id="json"></textarea>
            <button type="submit">Send</button>
        </form>


        <p>Kule templatevariabler du kan benytte deg av:</p>
        <ul>
            <li>{{uuidgen}}</li>
            <li>{{now}})</li>
            <li>{{now+5h}} (+/-, smhdwMy)</li>
            <li>{{today-5d}} (+/-, dwMy)</li>
            <li>{{NAVIdent}}</li>
            <li>{{navn}}</li>
            <li>{{epost}}</li>
        </ul>

        <p>NB: @id og @opprettet blir generert automagisk av spout ;D</p>
        <div id="jsoneditor"></div>

        <script type="module">
            import { JSONEditor, createAjvValidator } from 'https://cdn.jsdelivr.net/npm/vanilla-jsoneditor@0.16.0/index.js'

            const defaultJson = {
                '@event_name': "<fyll_meg>",
                fødselsnummer: "<fyll_meg>"
            }

            const schema = {
                properties: {
                    '@event_name': {
                        title: 'Eventnavn',
                        examples: ['påminnelse'],
                        type: 'string'
                    },
                    fødselsnummer: {
                        title: 'Fødselsnummer',
                        examples: ['12345678910'],
                        type: 'string'
                    }
                },
                required: ['@event_name', 'fødselsnummer']
            }
            const schemaDefinitions = {}

            const editor = new JSONEditor({
                target: document.getElementById('jsoneditor'),
                mode: 'text',
                props: {
                    validator: createAjvValidator({ schema, schemaDefinitions })
                }
            })
            editor.updateProps({
                mode: 'text',
                mainMenuBar: false
            })
            editor.set({json: defaultJson})

            const events =  document.getElementById('events')
            events.onchange = function () {
                let json;

                if (events.value === 'paminnelse') json = {
                    '@event_name': "paminnelse",
                    fødselsnummer: "<fyll_meg>",
                    aktørId: "<fyll_meg>",
                    organisasjonsnummer: "<fyll_meg>",
                    vedtaksperiodeId: "<fyll_meg>",
                    tilstand: "<fyll_meg>",
                    påminnelsestidspunkt: "{{now}}",
                    nestePåminnelsestidspunkt: "{{now+1h}}",
                    tilstandsendringstidspunkt: "{{now-1h}}",
                    antallGangerPåminnet: 1,
                    ønskerReberegning: false
                }
                else if (events.value === 'annullering') json = {
                    '@event_name': "annullering",
                    fødselsnummer: "<fyll_meg>",
                    aktørId: "<fyll_meg>",
                    saksbehandler: {
                        epostaddresse: "<fyll_meg>",
                        oid: "<fyll_meg>",
                        navn: "<fyll_meg>",
                        ident: "<fyll_meg>"
                    },
                    fagsystemId: "<fyll_meg>",
                    begrunnelser: [
                        "<fyll_meg>"
                    ]
                }
                else if (events.value === 'forkast_sykmeldingsperioder') json = {
                    '@event_name': "forkast_sykmeldingsperioder",
                    fødselsnummer: "<fyll_meg>",
                    aktørId: "<fyll_meg>",
                    organisasjonsnummer: "<fyll_meg>",
                    fom: "<fyll_meg>",
                    tom: "<fyll_meg>",
                }
                else json = defaultJson

                const content = { json }
                editor.set(content)
            }

            const sendmelding = document.getElementById('sendmelding')
            sendmelding.addEventListener("submit", (_) => {
                document.getElementById('json').innerText=JSON.stringify(editor.get())
            });
        </script>
    </body>
</html>